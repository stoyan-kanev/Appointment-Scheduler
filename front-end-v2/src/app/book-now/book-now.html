<main class="page">
    <section class="layout">

        <div
            class="side side--left"
            [style.--pattern]="'url(' + patternUrl + ')'"
            aria-hidden="true"
        ></div>

        <div class="panel">

            <div class="step">
                <div class="step__head">
                    <span class="step__badge">1</span>
                    <h3 class="step__title">Избери услугата</h3>
                </div>

                <div class="services">
                    <button class="tile" type="button"
                            (click)="selectService('haircut')"
                            [class.tile--active]="selectedService === 'haircut'">
                        <img class="tile__icon" src="scissors.png" alt="">

                        <div class="tile__text">
                            <div class="tile__name">Подстригване</div>
                            <div class="tile__meta">30 мин • 35лв</div>
                        </div>
                    </button>

                    <button class="tile" type="button"
                            (click)="selectService('beardTrim')"
                            [class.tile--active]="selectedService === 'beardTrim'"

                    >
                        <img class="tile__icon " src="beard.png" alt="">
                        <div class="tile__text">
                            <div class="tile__name">Брада</div>
                            <div class="tile__meta">20 мин • 20лв</div>
                        </div>
                    </button>

                    <button class="tile" type="button"
                            (click)="selectService('comboTrim')"
                            [class.tile--active]="selectedService === 'comboTrim'"
                    >
                        <img class="tile__icon smaller-img" src="face.png" alt="">
                        <div class="tile__text">
                            <div class="tile__name">Комбо</div>
                            <div class="tile__meta">60 мин • 50лв</div>
                        </div>
                    </button>

                    <button class="tile bigger-gap" type="button"
                            (click)="selectService('headShave')"
                            [class.tile--active]="selectedService === 'headShave'"

                    >
                        <img class="tile__icon " src="razor.png" alt="">
                        <div class="tile__text">
                            <div class="tile__name">Бръснене на глава</div>
                            <div class="tile__meta">30 мин • 20лв</div>
                        </div>
                    </button>

                    <button class="tile bigger-gap" type="button"
                            (click)="selectService('kingShave')"
                            [class.tile--active]="selectedService === 'kingShave'"

                    >
                        <img class="tile__icon" src="razor-blade.png" alt="">
                        <div class="tile__text">
                            <div class="tile__name">Кралско бръснене</div>
                            <div class="tile__meta">25 мин • 25лв</div>
                        </div>
                    </button>
                </div>
            </div>

            <hr class="divider"/>

            <div class="step">
                <div class="step__head">
                    <span class="step__badge">2</span>
                    <h3 class="step__title">Избери бръснар</h3>
                </div>

                <div class="barbers">
                    @if (barbers$ | async; as listOfBarbers) {
                        @for (barber of listOfBarbers; track trackBarber($index, barber)) {
                            <div class="barber-wrapper-select"
                                 [class.avatar--active]="selectedBarber?.id === barber.id"
                            >
                                <button
                                    class="avatar"
                                    type="button"
                                    (click)="selectBarber(barber)"
                                >
                                    <img
                                        [src]="barber.image"
                                        [alt]="barber.name"
                                        loading="lazy"
                                        decoding="async"
                                        width="68"
                                        height="68"
                                    >
                                </button>
                                <p>{{ barber.name }}</p>
                                <h6>{{barber.role | roleLabel}}</h6>
                            </div>
                        }
                    } @else {
                        <p>Зареждане...</p>
                    }
                </div>
            </div>

            <hr class="divider"/>

            <div class="step">
                <div class="step__head">
                    <span class="step__badge">3</span>
                    <h3 class="step__title">Избери дата и час</h3>
                </div>

                <div #bookingArea class="booking-area" [class.booking-area--disabled]="!canPickDateTime">

                    <div class="booking-toolbar">
                        <label class="booking-label">
                            Дата
                            <input
                                class="booking-input"
                                type="date"
                                [min]="minDate"
                                [disabled]="!canPickDateTime"
                                [(ngModel)]="selectedDate"
                                (ngModelChange)="onDateChange($event)"
                            />
                        </label>

                    </div>

                    @if (!canPickDateTime) {
                        <p class="booking-hint">Първо избери услуга и бръснар.</p>
                    } @else if (!selectedDate) {
                        <p class="booking-hint">Избери дата, за да видиш свободните часове.</p>
                    } @else if (availabilityLoading) {
                        <p class="booking-hint">Зареждане…</p>
                    } @else {
                        <div class="slots">
                            @for (slot of timeSlots; track slot) {
                                <button
                                    type="button"
                                    class="slot"
                                    [class.slot--active]="selectedSlot === slot"
                                    [disabled]="!isSlotFree(slot)"
                                    (click)="selectSlot(slot)"
                                >
                                    <span class="slot__time">{{ slot }}</span>
                                    <span class="slot__state">{{ isSlotFree(slot) ? 'Свободно' : 'Заето' }}</span>
                                </button>
                            }
                        </div>
                        @if (selectedSlot) {
                            <form #clientFormEl class="client-form" (ngSubmit)="confirmBooking()" #f="ngForm">

                                <div class="form-row">
                                    <label>
                                        Име
                                        <input
                                            type="text"
                                            name="first_name"
                                            required
                                            [(ngModel)]="clientForm.first_name"
                                        />
                                    </label>

                                    <label>
                                        Фамилия
                                        <input
                                            type="text"
                                            name="last_name"
                                            required
                                            [(ngModel)]="clientForm.last_name"
                                        />
                                    </label>
                                </div>

                                <div class="form-row">
                                    <label>
                                        Имейл
                                        <input
                                            type="email"
                                            name="email"
                                            required
                                            [(ngModel)]="clientForm.email"
                                        />
                                    </label>

                                    <label>
                                        Телефон
                                        <input
                                            type="tel"
                                            name="phone"
                                            required
                                            [(ngModel)]="clientForm.phone"
                                        />
                                    </label>
                                </div>

                                <button
                                    type="submit"
                                    class="booking-save"
                                    [disabled]="f.invalid || bookingInFlight"
                                >
                                    Потвърди резервацията
                                </button>

                            </form>
                        }
                    }


                </div>

            </div>

        </div>

        <div
            class="side side--right"
            [style.--pattern]="'url(' + patternUrl + ')'"
            aria-hidden="true"
        ></div>

    </section>
</main>
